general:
  artifacts:

## Customize the test machine
machine:
  # Add some environment variables
  environment:
    IS_LINUX: $([[ $CIRCLE_NODE_INDEX -eq 0 ]] && echo "y")
    IS_WIN32: $([[ $CIRCLE_NODE_INDEX -eq 1 ]] && echo "y")
    IS_ARM: $([[ $CIRCLE_NODE_INDEX -eq 2 ]] & echo "y")
    CROSS_COMPILE: >
      $(case $CIRCLE_NODE_INDEX in 
          1) host='i686-w64-mingw32-' ;; 
          2) host='arm-linux-androideabi-' ;; 
        esac; 
        echo $host)
    MKARG: $([ $IS_LINUX ] && echo 'dpdk=yes')
    PATH: /home/ubuntu/android-toolchain/bin:${PATH}
    SETUP_WIN32: $([ $IS_WIN32 ] && echo 'sudo cp tools/lkl/bin/i686-w64-mingw32-* /usr/bin')
    SETUP_ARM: >
      $([ $IS_ARM ] && echo 
          '/usr/local/android-ndk/build/tools/make-standalone-toolchain.sh 
          --platform=android-21 --install-dir=/home/ubuntu/android-toolchain --arch=arm && 
          cd tools/lkl &&
          make tests/boot-in.o &&
          arm-linux-androideabi-gcc -o tests/boot tests/boot-in.o liblkl.a -static')
    SETUP_LINUX: $([ $IS_LINUX ] && echo 'cd tools/lkl && ./scripts/dpdk-sdk-build.sh')
    COMMON_DEPS: > 
        bc libfuse-dev libarchive-dev xfsprogs valgrind qemu-user-static 
        linux-headers-$(uname -r)
    WIN_DEPS: $( [ $IS_WIN32 ] && echo 'gcc-mingw-w64-i686 wine')
    

## Customize dependencies
dependencies:
  pre:
    # required for 14.04 container
    # - sudo dpkg --add-architecture i386
    - sudo apt-get update; sudo apt-get install $COMMON_DEPS $WIN_DEPS

test:
  pre:
    - "$SETUP_ARM":
        parallel: true
    - [ $IS_LINUX ] && cd tools/lkl && ./scripts/dpdk-sdk-build.sh; fi
        parallel: true
    - if [ $IS_WIN32 ]; then sudo cp tools/lkl/bin/i686-w64-mingw32-* /usr/bin; fi
        parallel: true

  override:
    - cd tools/lkl &&  make -j8 ${MKARG}:
        parallel: true
    - cd tools/lkl && make test:
         parallel: true

    - ? >
        if [ -n "${RUN_NIGHTLY_BUILD}" ]; then
          cd tools/lkl && make valgrind;
        fi
      : timeout: 1800 # timeout to 30mins

  post:
    - mkdir -p $CIRCLE_TEST_REPORTS/junit/
    - find ./tools/lkl/ -type f -name "*.xml" -exec cp {} $CIRCLE_TEST_REPORTS/ \;
